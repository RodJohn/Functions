

# 用户部分

## 功能描述

## 1. 用户来源  

    是否仅有企业内部用户,
    是否有外部用户,
    是否需要按照组织架构显示
    需要企业内部用户接口,
    和相应的触发更新
## 5 api 

    查询用户
    
    双向修改    
    
## 3. 用户识别

    由apigateway给出    

## 表结构

### 用户表结构(t_im_user)

    user_id     用户id    
    status      状态(在线/离线) 
    name        用户名  (用户名,头像也可以考虑不要 )  
    head_icon   头像    (用户名,头像也可以考虑不要 )  


    
    
# 聊天

## 功能描述

### 点对点聊天+群聊

   点对点聊天通过加人可以升级为群聊

### 多种数据形式

    可发送的数据类型:文字,表情,图片,文件
    图片.附件只能单独单个发送
    文字和表情之间可以混排
    表情使用特别前缀后缀识别
    
### 推送消息状态

    消息状态:未接受/已接收/已读

### 会话列表

显示方式

   按是否存在未读消息和最后聊天时间倒序
   显示 聊天名 用户名 聊天图像  未读消息数量 最后一条消息  最后聊天时间

用户重新登录时,查询该会话列表


### 消息查询

聊天记录翻页查询
    
    一个月内的数据存本地关系数据库
    超过一个月的数据,从本地物理删除,存在es中
    es中数据结构

search contact 

    按照内容+用户查询      
       
## 问题

### 消息时序性

    server_time
    
### 批量删除

    定时删除--空洞    
           

## 表设计


### 聊天频道信息表 (t_im_channel)

    channel_id        频道id
    channel_name      频道名称
    channel_type      频道类型  (群聊/非群聊  冗余)
    creator           创建人id
    create_time       创建时间
    owner             管理员
    announcement      频道公告
    
    
### 聊天室用户表   (t_im_channel_user)
   
    channel_id      频道id
    user_id         用户id
    role            用户角色(管理员/非管理员 冗余)    
    
### 消息表 (t_im_message)

    ms_id           消息id
    channel_id      频道id
    server_time     服务器接受时间
    sender          发送人id  
    ms_type         消息类型(文字&&表情 /图片/附件)  (可不要)   
    content         消息正文  


### 消息推送表 (t_im_message_push)


    ms_id               消息id
    channel_id          频道id
    receiver            接受人id
    status              状态(未接受/已接收/已读  )  
    last_modified_time  最后修改时间    


### 表情识别表 (t_im_emoji)  

    emoji_id    表情id
    address     地址(key或者url)

# 问题


ok
user_msg_send
    应为原始数据记录表
    中没有必要设计 msg_to
    send_time应为server_time表示服务器时间 (可作为会话排序)
    
    
消息状态表(拆分动作值)

    群聊天是否需要使用该表
    
    加入状态字段
    
    未接受  服务器分发消息
    已接收  apigateway推送成功
    已读    前端给出明确消息

ok    
推送数据表 原始数据表 直接放入 es 的问题  

    我们用的是  httpChlient调用其他服务 不是长连接 
    不是直接操作ES 
    
    应该分批放入
 
表情表
 
是否需要离线消息表    

# 

    大群的批量插入数据  批量修改 锁表
 
 
    
    在线发送成功未读
    不在线
    重新登录后会话的记录   发送成功未读是否im会重新发送     
    用户离线  发送成功未读
 
    举例:
        A在线,B给A发送5条消息,但是A没有去阅读
        然后A退出系统,C给A发送5条消息
        下一次A重新登录时,
        重新拉取会话列表(从ES里面拉取比最大已读消息ID还大的,倒序99条)
        就应该出现BC的未读消息
        
        以上两种情况
        
        IM只做实时的增量推送,异步写ES
        未读消息,离线消息由
        会话历史消息从ES查询
        
        
        
        
                
               
    

